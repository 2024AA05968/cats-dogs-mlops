name: Build and Push Docker Image (GHCR)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Ensure git-lfs is available (safe even if already installed)
      - name: Install Git LFS
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install --local

      # Pull ONLY the model file from LFS (avoid downloading full dataset)
      - name: Pull model artifact from Git LFS
        run: |
          git lfs pull --include="models/baseline_cnn.pt" --exclude=""
          echo "== Model file details =="
          ls -lh models/baseline_cnn.pt

          echo "== First line (should NOT be LFS pointer) =="
          head -n 1 models/baseline_cnn.pt || true

          # Fail fast if still a pointer
          if head -n 1 models/baseline_cnn.pt | grep -q "git-lfs.github.com/spec"; then
            echo "ERROR: models/baseline_cnn.pt is still a Git LFS pointer. Failing build."
            exit 1
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=sha,format=short

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}